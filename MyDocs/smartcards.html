
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.0.5">
    
    
  <title>Michael's Site</title>

    
      <link rel="stylesheet" href="../assets/stylesheets/main.a617204b.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.9204c3b2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#smart-card-programming" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="Scarbrough@GitHub" class="md-header__button md-logo" aria-label="Scarbrough@GitHub" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Scarbrough@GitHub
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Smart Card Programming
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../index.html" class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../projects.html" class="md-tabs__link">
      Projects
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="index.html" class="md-tabs__link md-tabs__link--active">
        My Docs
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Scarbrough@GitHub" class="md-nav__button md-logo" aria-label="Scarbrough@GitHub" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Scarbrough@GitHub
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../projects.html" class="md-nav__link">
        Projects
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="index.html">My Docs</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="My Docs" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          My Docs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="suggested-toolset.html" class="md-nav__link">
        Suggested Toolset
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="development-standards.html" class="md-nav__link">
        Development Standards
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="software-architecture-doc.html" class="md-nav__link">
        Software Architecture Document
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="github.html" class="md-nav__link">
        GitHub
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="docker.html" class="md-nav__link">
        Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="solid.html" class="md-nav__link">
        SOLID Development
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="jso n-web-tokens.md" class="md-nav__link">
        JSON Web Tokens
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="linux-kernel-module.html" class="md-nav__link">
        Linux Kernel Modules
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="opencart.html" class="md-nav__link">
        OpenCart Development Notes
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_11" type="checkbox" id="__nav_3_11" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_11">
          DotNet
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="DotNet" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_11">
          <span class="md-nav__icon md-icon"></span>
          DotNet
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="dotnet-core-6-ajax.html" class="md-nav__link">
        AJAX Requests in DotNET Core 6 MVC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="ajax-view-injection.html" class="md-nav__link">
        AJAX View Injection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="web-services.html" class="md-nav__link">
        Web Services
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="web-apis.html" class="md-nav__link">
        Web APIs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="code-first-setup.html" class="md-nav__link">
        Code First Entity Framework
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="identity-users-extension.html" class="md-nav__link">
        Extending ASP.NET IdentityUsers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="dotnet-core-6-mvc.html" class="md-nav__link">
        DotNET Core 6 MVC and Entity Framework
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_12" type="checkbox" id="__nav_3_12" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_12">
          Database
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Database" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_12">
          <span class="md-nav__icon md-icon"></span>
          Database
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="basic-sql.html" class="md-nav__link">
        Basic SQL Scripts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="sqlite.html" class="md-nav__link">
        SQLite3
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_13" type="checkbox" id="__nav_3_13" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_13">
          Python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Python" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_13">
          <span class="md-nav__icon md-icon"></span>
          Python
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="jupyter.html" class="md-nav__link">
        Jupyter Notebooks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="pycrypto-aes.html" class="md-nav__link">
        PyCrypto AES
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="python-authentication.html" class="md-nav__link">
        Authentication with Python
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Smart Card Programming
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="smartcards.html" class="md-nav__link md-nav__link--active">
        Smart Card Programming
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-kit" class="md-nav__link">
    The Kit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acos3-microprocessor-card" class="md-nav__link">
    ACOS3 Microprocessor Card
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-card-reader" class="md-nav__link">
    The Card Reader
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#communication-and-test" class="md-nav__link">
    Communication and Test
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#application-data-protocol-units" class="md-nav__link">
    Application Data Protocol Units
  </a>
  
    <nav class="md-nav" aria-label="Application Data Protocol Units">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apdus-and-machine-code" class="md-nav__link">
    APDUs and Machine Code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acos3-programming-overview" class="md-nav__link">
    ACOS3 Programming Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gscriptor" class="md-nav__link">
    (g)scriptor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python" class="md-nav__link">
    Python
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-kit" class="md-nav__link">
    The Kit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acos3-microprocessor-card" class="md-nav__link">
    ACOS3 Microprocessor Card
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-card-reader" class="md-nav__link">
    The Card Reader
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#communication-and-test" class="md-nav__link">
    Communication and Test
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#application-data-protocol-units" class="md-nav__link">
    Application Data Protocol Units
  </a>
  
    <nav class="md-nav" aria-label="Application Data Protocol Units">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apdus-and-machine-code" class="md-nav__link">
    APDUs and Machine Code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acos3-programming-overview" class="md-nav__link">
    ACOS3 Programming Overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gscriptor" class="md-nav__link">
    (g)scriptor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python" class="md-nav__link">
    Python
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="smart-card-programming">Smart Card Programming</h1>
<p>Under the right conditions, Smart Cards are an almost perfect method of two-factor authentication – authenticating data is stored on the card encrypted, and the cryptographic key is derived from the PIN. In other words, the card and the owner’s PIN is required to complete the authentication.</p>
<p>But what’s to prevent an attacker reading the data off the EEPROM and bruteforcing the encryption? Something else is needed to implement access control. In this case it’s a microprocessor that mediates access to the EEPROM where the data is stored, along with some level of tamper-resistance to prevent that memory being accessed directly. Read/Write operations must therefore be performed through the microprocessor. After a little probing I learned that it’s the microprocessor itself, and not an ATM machine, that manages PIN changes and bricks a bank card after three incorrect PINs are entered.</p>
<p>The non-management aim of my project, which is slightly related to my work on the IPv6 darknet, is simple: To develop an application that uses Smart Cards as a method of storing cryptographic keys for secure Internet-based comms. Ideally the cards themselves would be endpoints in a widely deployed comms network.</p>
<p>The first step is to create software that calls various functions to interact with a card’s microprocessor. Currently I have installed:</p>
<ul>
<li>libpam-p11: PAM modules for PKCS#11 Smart Cards.  </li>
<li>libpcsclite: PCSC Lite library.  </li>
<li>OpenCT  </li>
<li>OpenSC: Libraries and utilities for interacting with Smart Cards  </li>
<li>OpenSC PKCS#11 APIs.  </li>
<li>pcsc_scan  </li>
<li>pcsc-tools  </li>
<li>pcscd: Middleware.  </li>
<li>pyscard: <a href="http://pyscard.sourceforge.net/">Smart Card module for Python</a>.</li>
</ul>
<h3 id="the-kit">The Kit</h3>
<p>What I ordered from <a href="http://www.smartcardfocus.com/">SmartCard Focus</a> was pretty much the cheapest and most generic hardware I could find, so there’s the greatest chance of getting Python modules, OpenSC, OpenPGP and maybe C++ libraries (as a last resort) to interact with the cards:<br />
- 3x <a href="http://www.acs.com.hk/en/products/19/acos3-microprocessor-card/">ACOS3 ISO 7816 Smart Cards</a> with 32KB EEPROM<br />
- 1x <a href="http://www.gemalto.com/products/pc_link_readers/">Gemalto IDBridge CT30</a> card reader<br />
- Drivers and utilities for Microsoft Windows</p>
<p>SmartCard Focus also do cheap RF shielding products for protecting RFID cards.</p>
<h3 id="acos3-microprocessor-card">ACOS3 Microprocessor Card</h3>
<p>The <a href="http://www.acs.com.hk/en/products/19/acos3-microprocessor-card/">cards themselves</a> were designed on the ISO 7816 standard (which isn’t what the banks <em>primarily</em> use), and memory access is mediated by the card’s own microprocessor. Of course, this wasn’t originally what I had in mind when starting the project, preferring to read/write data as encrypted blocks with the card acting simply as a storage medium for an encrypted block of data.</p>
<p>The ACOS3 isn’t suitable for high-security applications such as ‘e-government’ or national ID schemes, partly (perhaps mainly) because their microprocessors handle DES/Triple-DES only, so you’re either getting 64-bit (which is actually 48-bit) or 192-bit encryption depending on the specific Triple-DES method. Interestingly, I’ve learned, through a bit of field research, that some Chip-and-PIN payment systems still work with an ACOS3 card.</p>
<h3 id="the-card-reader">The Card Reader</h3>
<p>According to Gemalto’s product description, the IDBridge CT30 is a very basic card reader that works with any ISO 7816 Smart Card. In theory it acts simply as a data bus between the USB port and the card contacts, but in practice card readers have a controller chip that might need additional drivers.</p>
<h3 id="communication-and-test">Communication and Test</h3>
<p>So far I’ve done some initial testing of the hardware with ACOS3 and a range of other cards. The <em>OpenCT</em> and <em>OpenSC</em> tools detected the reader perfectly, but getting Linux-based stuff talking with the microprocessors is really a matter of testing different manufacturers and libraries, even though numerous technical docs say that certain types should work. The <em>pcsc_scan</em> tool reads the chip parameters and correctly identified the card manufacturer, so there’s definitely some communication happening with the processor.</p>
<p>I’ve yet to properly try this with Python modules or C++ libraries (which I’ve also installed).</p>
<h2 id="application-data-protocol-units">Application Data Protocol Units</h2>
<p>The functions are provided by an internal chip containing sets of transistors in different configurations, and a machine code instruction (e.g. 0111) is just a reference to physical pins feeding the chip. When voltage is applied to the right pins, data is passed from a tiny diode array (memory register A), through a specific transistor configuration and into another diode array (memory register B). In turn, the memory registers themselves cache whatever data was fetched from RAM. This is the long and short of what’s happening at the hardware level, and ultimately what happens when people run any program/application on their computer.</p>
<h3 id="apdus-and-machine-code">APDUs and Machine Code</h3>
<p>Communication with the microprocessor is done at a very low level, as byte strings called ‘Application Protocol Data Units’ (APDUs). The concept is vaguely similar to that of TCP packets, in that it involves a header and payload. The header is always 4 bytes in length (at least with the ACOS3), even when not all of them are used. The first byte is the machine code instruction itself, and because we’re dealing with direct memory addressing we also specify the number of bytes to be processed when the instruction executes.</p>
<p>While APDUs are pretty standard across most microprocessor-based cards, the instruction sets appear to be vendor-specfic. Knowing exactly how to put together an instruction demands a bit of research, being shit hot at hex-binary-ASCI-decimal conversion and the ability to keep track of memory addresses (or offsets) being used. Luckily SmartCard Focus had included enough documentation (especially the ACOS3 Smart Card Reference Manual) and an excellent range of diagnostic tools on the CD to make the task slightly easier.</p>
<h3 id="acos3-programming-overview">ACOS3 Programming Overview</h3>
<p>A typical instruction for the ACOS3’s microprocessor has the initial instruction and data length bytes, followed by the payload, which I estimate to have a max size of around 250-253 bytes.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>[Instruction] [Data Length] [Data] [Data] ... [Data]
</code></pre></div>
<p>To write data to the card’s EEPROM, the command must also specify the address to write to and how many bytes should be written there. This is important because we’re not dealing with files. Data is overwritten instead of deleted, and data blocks can only be addressed as offsets from the EEPROM’s start location (whatever that might be).
For the ACOS3 the write instruction is always 91h. As an example, if we wanted to write ‘Hello World’ to memory address 3Ah on the card’s EEPROM, the pseudocode would be something like:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a>[Instruction] [Data Length] [Memory Address] [Memory Address] [Data] [Data]
</code></pre></div>
<p><code>WRITE: 11 BYTES TO 00 3Ah: HELLO WORLD</code></p>
<p>Which translates into the following instruction:</p>
<p><code>91 00 3A 48 65 6C 6C 6F 20 57 6F 72 6C 64</code></p>
<p>It’s a similar case with reading the data back off the card, as we must specify how many bytes to read from a given adress. Here the machine code instruction is 90h. If we wanted to read ‘Hello World’ from the address it was written to earlier, the pseudocode would be something like:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a>[Instruction] [Data Length] [00] [Memory Address] [Length]
</code></pre></div>
<p><code>READ: 11 BYTES FROM 00 3Ah: 00</code></p>
<p>Which gives us:
<code>90 00 00 00 3A 0A</code></p>
<p>There are a couple more things I tried out with the ACOS3 and some other cards. The crypto processor has a PRNG, and a 64-bit pseudo-random number (suffixed with a status code) is generated by sending instruction ’<code>80 84 00 00 08</code>′. It probably uses this to generate session keys for transactions, which would mean the Triple-DES function is only using a 64-bit key. If the processor’s PRNG is capable of generating a 128-bit value (which is a 16-bytes), we could get that by substituting the last byte with ’10’ (10h = 16).</p>
<p>If the card’s messed up, it could be reset to its factory state with ’<code>80 30 00 00 00</code>′. The ’<code>80 24 00 00 08 5555</code>′ command changes the PIN to ‘5555’. What we should start to notice is a pattern in the instruction set, where ’80h’ refers to control operations, ’90h’ refers to read operations, and ’91h’ instructions write data.</p>
<h3 id="gscriptor">(g)scriptor</h3>
<p>Is there an IDE for writing machine code to a Smart Card? Well, there sort of is one, in the form of <a href="http://ludovic.rousseau.free.fr/softwares/pcsc-tools/index.html">(g)scriptor</a>. This tool can run a sequence of predefined bytestrings as a ‘script’, so a series of operations could be automated. It’s important to confirm the reader is connected and the card’s processor is functioning, by selecting ‘<em>Reader — Status…</em>’.</p>
<p>Now we can send bytes to the card and see what’s returned. Here I think I’ve established that ‘<code>6E 00</code>′ is an error message or no response, while ’<code>90 00</code>’ is okay message.</p>
<h3 id="python">Python</h3>
<p>Unfortunately I haven’t got very far writing decent Smart Card programs for Python, for the reasons above. At the moment I only have a script, using the PysCard module, that does generic card reader detection and <a href="https://en.wikipedia.org/wiki/Answer_to_reset">ATR reading</a>.</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="python-authentication.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: Authentication with Python" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Authentication with Python
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.sections", "navigation.indexes"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.cefbb252.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.a5f8ea78.min.js"></script>
      
    
  </body>
</html>